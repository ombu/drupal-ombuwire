<?php
/**
 * @file ombuwire.module
 */

/**
 * STATE Definitions
 */
define('OMBUWIRE_NOT_STARTED', 'not-started');
define('OMBUWIRE_WIREFRAME', 'wireframe');
define('OMBUWIRE_DESIGN', 'design');
define('OMBUWIRE_STATIC', 'static');
define('OMBUWIRE_IN_PROGRESS', 'in-progress');
define('OMBUWIRE_IMPLEMENTED', 'implemented');

/**
 * Implements hook_theme().
 */
function ombuwire_theme($existing, $type, $theme, $path) {
  return array(
    'ombuwire_page_wireframe' => array(
      'variables' => array('url' => NULL),
      'file' => 'ombuwire.theme.inc',
    ),
    'ombuwire_page_design' => array(
      'variables' => array('url' => NULL),
      'file' => 'ombuwire.theme.inc',
    ),
    'ombuwire_page_image' => array(
      'variables' => array('url' => NULL),
      'file' => 'ombuwire.theme.inc',
    ),
    'ombuwire_page_static' => array(
      'variables' => array('url' => NULL),
      'file' => 'ombuwire.theme.inc',
    ),
    'ombuwire_sidebar' => array(
      'variables' => array(),
      'file' => 'ombuwire.theme.inc',
    ),
  );
}

function ombuwire_theme_registry_alter(&$theme_registry) {
  $theme_registry['html__ombuwire'] = $theme_registry['html'];
  $theme_registry['html__ombuwire']['path'] = drupal_get_path('module', 'ombuwire') .'/templates';
  $theme_registry['page__ombuwire'] = $theme_registry['page'];
  $theme_registry['page__ombuwire']['path'] = drupal_get_path('module', 'ombuwire') .'/templates';
}

/**
 * Implements hook_block_info().
 */
function ombuwire_block_info() {
  $blocks = array();
  foreach(_ombuwire_blocks_needed() as $size) {
    $i = 1;
    $delta = sprintf('fpo_%d_%d_%d', $size[0], $size[1], $i);
    while(array_key_exists($delta, $blocks)) {
      $i++;
      $delta = sprintf('fpo_%d_%d_%d', $size[0], $size[1], $i);
    }
    $info = sprintf('FPO %dx%d', $size[0], $size[1]);
    $blocks[$delta]['info'] = $info;
    $blocks[$delta]['cache'] = DRUPAL_NO_CACHE;
    $blocks[$delta]['title'] = $info;
  }
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function ombuwire_block_view($delta = '') {
  if(preg_match('/^fpo_(\d+)_(\d+)_/', $delta, $matches)) {
    $block['subject'] = t('FPO');
    $block['content'] = _ombuwire_get_fpo_block($matches[1], $matches[2]);
    return $block;
  }
}

/**
 * Implements hook_preprocess_block().
 */
function ombuwire_preprocess_block(&$variables) {
  if($variables['block']->module == 'ombuwire' && strpos($variables['block']->delta,'fpo_') === 0) {
    $variables['classes_array'][] = 'block-ombuwire-fpo';
  }
}

/**
 * Implements hook_preprocess_html()
 */
function ombuwire_preprocess_html(&$variables) {
  if (is_array($variables['page']['content']['system_main']) &&
        array_key_exists('#ombuwire', $variables['page']['content']['system_main'])) {
    $obj = $variables['page']['content']['system_main']['#ombuwire'];
    $variables['classes_array'][] = 'ombuwire';
    if (isset($obj['#display'])) {
      $variables['classes_array'][] = 'ombuwire-'. $obj['#display'];
      if ($obj['#display'] != 'root') {
        $variables['theme_hook_suggestions'][] = 'html__ombuwire';
        unset($variables['page']['page_top']['#theme_wrappers']);
        unset($variables['page']['page_bottom']['#theme_wrappers']);
      }
    }
  }
}

/**
 * Implements hook_preprocess_page()
 */
function ombuwire_preprocess_page(&$variables) {
  if (is_array($variables['page']['content']['system_main']) &&
        array_key_exists('#ombuwire', $variables['page']['content']['system_main'])) {
    $obj = $variables['page']['content']['system_main']['#ombuwire'];
    if (isset($obj['#display']) && $obj['#display'] != 'root') {
      $variables['theme_hook_suggestions'][] = 'page__ombuwire';
    }
  }
  global $theme;
  if ($theme != variable_get('admin_theme', 'ombuadmin')) {
    $variables['page']['page_bottom']['ombuwire_sidebar'] = array('#theme' => 'ombuwire_sidebar');
  }
}

/**
 * Implementes hook_preprocess_region()
 */
function ombuwire_preprocess_region(&$variables) {
  $human_name = ucwords(str_replace('_', ' ', $variables['region']));
  $variables['content'] .= "<label class='region-label'>$human_name</label>";
}

/**
 * Implements hook_library().
 */
function ombuwire_library() {
  $libraries['ombuwire'] = array(
    'title' => 'OMBU Wire Menu',
    'version' => '0.1',
    'js' => array(
      drupal_get_path('module', 'ombuwire') . '/js/ombuwire.js' => array(),
    ),
    'css' => array(
      drupal_get_path('module', 'ombuwire') . '/css/ombuwire.css' => array(),
    ),
    'dependencies' => array(
      array('system', 'jquery.cookie'),
    ),
  );
  return $libraries;
}

/**
 * Implements hook_page_delivery_callback_alter()
 */
function ombuwire_page_delivery_callback_alter(&$delivery_callback) {
  $delivery_callback = 'ombuwire_delivery_callback';
}

/**
 *  Module functions
 */

function _ombuwire_get_fpo_block($width = 100, $height = 100)  {
  return sprintf("<div class='fpo' style='width: %dpx; height: %dpx'></div>",
    $width, $height);
}

/**
 * @todo Should be a site variable or hook
 */
function _ombuwire_blocks_needed() {
  return array(
    array(460,260),
    array(223,305),
    array(223,305),
    array(223,305),
  );
}

/**
 * Return the sitemap array
 */
function ombuwire_get_sitemap() {
  static $warned = FALSE;
  $sitemap = module_invoke_all('ombuwire_sitemap');
  if (empty($sitemap) && !$warned) {
    $message = "No ombuwire sitemap found. ";
    $message .= "An example of the `hook_ombuwire_sitemap()` function can be found at '". drupal_get_path('module', 'ombuwire');
    $message .= "/ombuwire.api.php'.";
    drupal_set_message($message, 'warning');
    $warned = TRUE;
  }
  return $sitemap;
}

/**
 * Returns the flat sitemap, keyed by path.  Function used recursively.
 */
function ombuwire_get_sitemap_flat($map = NULL) {
  $map = ($map === NULL) ? ombuwire_get_sitemap() : $map;
  $paths = array();
  foreach ($map as $path => $array) {

    if (is_numeric($path)) {
      // Skip items without a url key
      continue;
    }

    $children = array();
    if (!empty($array['#children'])) {
      $children = ombuwire_get_sitemap_flat($array['#children']);
      unset($array['#children']);
    }
    $paths[$path] = $array;
    $paths = array_merge($paths, $children);
  }
  return $paths;
}

/**
 * ombuwire implementation of the delivery_callback
 */
function ombuwire_delivery_callback($page_callback_result) {

  // get the original $delivery_callback
  $router_item = menu_get_item();
  $delivery_callback = !empty($router_item['delivery_callback']) ? $router_item['delivery_callback'] : 'drupal_deliver_html_page';
  $requested_path = drupal_get_path_alias(current_path());
  $sitemap_flat = ombuwire_get_sitemap_flat();

  if ($page_callback_result === MENU_NOT_FOUND ||
      array_key_exists($requested_path, $sitemap_flat) ||
      (drupal_is_front_page() && array_key_exists('<front>', $sitemap_flat))) {

    $sitemap_item = FALSE;
    $display = FALSE;
    $root_path = FALSE;

    // non-drupal display path
    if ($page_callback_result === MENU_NOT_FOUND && !array_key_exists($requested_path, $sitemap_flat)) {
      $path_parts = explode('/', $requested_path);
      $root_path = implode('/', array_slice($path_parts, 0, -1));
      $display = end($path_parts);
      if (empty($root_path)) {
        $root_path = '<front>';
      }
      if (isset($sitemap_flat[$root_path])) {
        $sitemap_item = $sitemap_flat[$root_path];
      }
    }
    // display is 'root'
    elseif (array_key_exists($requested_path, $sitemap_flat)) {
      $display = 'root';
      $root_path = $requested_path;
      $sitemap_item = $sitemap_flat[$requested_path];

      // Add messaging if Drupal callback doesn't exist
      if ($page_callback_result === MENU_NOT_FOUND) {
        $display_links = array();
        foreach ($sitemap_item as $key => $val) {
          if (stristr($key, '#') === FALSE) {
            $display_links[] = l(ucwords($key), $root_path.'/'.$key);
          }
        }
        $message = "This page has not yet been implemented.";
        if (!empty($display_links)) {
          $message .= " View the ". ombuwire_format_comma_list($display_links) .' instead.';
        }
        drupal_set_message($message, 'warning');
      }
    }

    if ($root_path) {
      ombuwire_active_root_path($root_path);
    }

    if ($sitemap_item) {
      if (!is_array($page_callback_result)) {
        $page_callback_result = array();
      }
      if (in_array($display, array_keys($sitemap_item))) {
        // The display version has a key in the array. Ex: 'wireframe', 'design', etc.
        // Otherwise it's the actual implementation
        $page_callback_result = array(
          '#theme' => 'ombuwire_page_'. $display,
          '#url' => $sitemap_item[$display],
        );
      }
      $page_callback_result['#ombuwire'] = array(
        '#display' => $display,
      );
    }
  }

  $delivery_callback($page_callback_result);
}

function ombuwire_active_root_path($path = FALSE) {
  static $internal = NULL;

  if ($path != FALSE) {
    $internal = $path;
  }

  return $internal;
}

function ombuwire_format_comma_list($items, $final_glue = 'or') {
  $last = array_pop($items);
  if (count($items) == 0) {
    return $last;
  }
  return implode(', ', $items) ." $final_glue $last";
}
